name: Publish to PowerShell Gallery

on:
  workflow_run:
    workflows: ["Release"]
    types:
      - completed

permissions:
  contents: read

jobs:
  test:
    name: Pester
    runs-on: ubuntu-latest

    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Install Pester
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = 'Stop'
          Install-Module Pester -Force -Scope CurrentUser -MinimumVersion 5.0.0

      - name: Run tests
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = 'Stop'
          Invoke-Pester -Path "./GitSplit.Tests.ps1" -CI -Output Detailed

  publish:
    name: Publish
    runs-on: ubuntu-latest
    needs: [ test ]

    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Publish to PSGallery
        shell: pwsh
        env:
          PSGALLERY_API_KEY: ${{ secrets.PSGALLERY_API_KEY }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = 'Stop'

          if (-not $env:PSGALLERY_API_KEY) {
            throw 'Missing secret PSGALLERY_API_KEY'
          }

          $moduleName = 'GitSplit'
          $manifestPath = Join-Path $PWD "$moduleName.psd1"

          if (-not (Test-Path $manifestPath)) {
            throw "Manifest not found at $manifestPath"
          }

          $manifest = Import-PowerShellDataFile -Path $manifestPath
          $version = [string]$manifest.ModuleVersion
          Write-Host "Publishing $moduleName version $version" -ForegroundColor Cyan

          # Publish-Module expects the module in a folder named after the module.
          $stagingRoot = Join-Path $env:RUNNER_TEMP 'psgallery'
          $moduleFolder = Join-Path $stagingRoot $moduleName
          New-Item -Path $moduleFolder -ItemType Directory -Force | Out-Null

          Copy-Item -Path "$moduleName.psm1" -Destination $moduleFolder -Force
          Copy-Item -Path "$moduleName.psd1" -Destination $moduleFolder -Force
          if (Test-Path 'LICENSE') { Copy-Item -Path 'LICENSE' -Destination $moduleFolder -Force }
          if (Test-Path 'README.md') { Copy-Item -Path 'README.md' -Destination $moduleFolder -Force }

          Publish-Module -Path $moduleFolder -NuGetApiKey $env:PSGALLERY_API_KEY -Repository PSGallery
